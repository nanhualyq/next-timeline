<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title>云风的 BLOG</title>
    <link rel="alternate" type="text/html" href="https://blog.codingnow.com/" />
    <link rel="self" type="application/atom+xml" href="https://blog.codingnow.com/atom.xml" />
   <id>tag:blog.codingnow.com,2025://1</id>
    <updated>2025-11-28T10:55:12Z</updated>
    <subtitle>思绪来得快去得也快，偶尔会在这里停留</subtitle>
    <generator uri="http://www.sixapart.com/movabletype/">Movable Type 3.2b5</generator>
 
<entry>
    <title>欧陆风云5的游玩笔记</title>
    <link rel="alternate" type="text/html" href="https://blog.codingnow.com/2025/11/eu5_notes.html" />
    <id>tag:blog.codingnow.com,2025://1.1319</id>
    
    <published>2025-11-28T10:53:55Z</published>
    <updated>2025-11-28T10:55:12Z</updated>
    
    <summary>最近一个月共玩了 270 小时的欧陆风云5 ，这两天打算停下来。最近在游戏后期打大战役时，交互已经卡得不行。我已经是 i9-14900K 的 CPU ，估计升级硬件已经无法解决这个问题，只能等版本更新优化了。 ps. 其实只要把游戏暂停下来立刻就不卡了。虽然我直到这个游戏需要的计算量非常大，但是卡交互操作肯定是实现的不对。因为这并不是因为渲染负荷造成的卡顿，可以让游戏时间流逝更慢一些，也不应该让鼠标点击后的界面弹出时间变长。 在暂置游戏前，我先把一些关于游戏设计上的理解先记录下来。也是对上一篇的补充。 在最初几十小时的游戏时间里，我一直想确认游戏经济系统的基础逻辑。和很多类似策略游戏不同，欧陆风云5 在游戏一开始，展现给玩家的是一个发展过（或者说是设定出来）的经济系统版图。玩家更需要了解的是他选择扮演的国家在当下到底面临什么问题，该怎样解决。这不只是经济，也包括政治、文化和军事。而很多游戏则是设定好规则，让玩家从零开始建设，找到合适的发展路径。 大多数情况下，EU5 玩家一开始考虑的并不是从头发展，所以在游戏新手期也没有强烈的理解游戏底层设计细节的动机。不过游戏也有开荒玩法，在游戏中后期势必会在远方殖民、开拓新大陆；甚至游戏还设计了让玩家直接转换视角以新殖民地为核心来继续游戏。但即使的重新殖民，在四周鸟无人烟的地方开荒，和在已有部分发展的区域附近拓展也完全不同。 我十分好奇这样一个复杂的经济系统是怎样启动起来的，所以仔细做了一点归纳笔记。不一定全对，但很多信息在游戏内的说明和目前的官方 wiki 都不完整，只能自己探索。...</summary>
    <author>
        <name>云风</name>
        <uri>http://www.codingnow.com</uri>
    </author>
            <category term="游戏" />
    
    <content type="html" xml:lang="en" xml:base="https://blog.codingnow.com/">
        <![CDATA[<p>最近一个月共玩了 270 小时的欧陆风云5 ，这两天打算停下来。最近在游戏后期打大战役时，交互已经卡得不行。我已经是 i9-14900K 的 CPU ，估计升级硬件已经无法解决这个问题，只能等版本更新优化了。</p>

<p>ps. 其实只要把游戏暂停下来立刻就不卡了。虽然我直到这个游戏需要的计算量非常大，但是卡交互操作肯定是实现的不对。因为这并不是因为渲染负荷造成的卡顿，可以让游戏时间流逝更慢一些，也不应该让鼠标点击后的界面弹出时间变长。</p>

<p>在暂置游戏前，我先把一些关于游戏设计上的理解先记录下来。<a href="https://blog.codingnow.com/2025/11/eu5.html">也是对上一篇的补充</a>。</p>

<p>在最初几十小时的游戏时间里，我一直想确认游戏经济系统的基础逻辑。和很多类似策略游戏不同，欧陆风云5 在游戏一开始，展现给玩家的是一个发展过（或者说是设定出来）的经济系统版图。玩家更需要了解的是他选择扮演的国家在当下到底面临什么问题，该怎样解决。这不只是经济，也包括政治、文化和军事。而很多游戏则是设定好规则，让玩家从零开始建设，找到合适的发展路径。</p>

<p>大多数情况下，EU5 玩家一开始考虑的并不是从头发展，所以在游戏新手期也没有强烈的理解游戏底层设计细节的动机。不过游戏也有开荒玩法，在游戏中后期势必会在远方殖民、开拓新大陆；甚至游戏还设计了让玩家直接转换视角以新殖民地为核心来继续游戏。但即使的重新殖民，在四周鸟无人烟的地方开荒，和在已有部分发展的区域附近拓展也完全不同。</p>

<p>我十分好奇这样一个复杂的经济系统是怎样启动起来的，所以仔细做了一点归纳笔记。不一定全对，但很多信息在游戏内的说明和目前的官方 wiki 都不完整，只能自己探索。</p>
]]>
        <![CDATA[<hr />

<p>游戏中的一切来源于“原产”，官方称为 ROG ，比较类似异星工厂里的矿石。上层的一切都是从原产直接或间接获得。版图上的任何一个最小单位的地块，只要上面有人口，就会不断生产出唯一品种的原材料进入这个世界。它和国家控制力、市场接入度都无关系。比原材料更高级的产品都是由原产直接或间接转换而来。</p>

<p>货币本身在世界中不以资源形式存在，货币本身也没有价值。货币的存在在于推动包括原产在内的原材料和产品等在世界中的流动。所以，世界中即使不存在经济活动、没有货币，亦或是货币急剧膨胀，这些因为国家破产而债务消失等让货币总值急剧变化的行为也不会直接影响这个世界中的物资变化。即没有很多游戏中直接用钱凭空兑换成物资的途径。</p>

<p>换句话说，如果整个世界缺铁，那么只能通过生产手段慢慢的产出，再多的钱也无法变出铁来。但分配更多的人力去生产、更高的科技水平可以获得铁产量的提升、使用更高效的配方、各种提升生产率的增益等等都可以加快铁的产出速度。</p>

<p>从一个世界的局部看（这是一般玩家的视野），获得原材料的方式有三种：</p>

<ol>
<li>养活更多的劳工或奴隶开发对应原产。</li>
<li>在合适的地理位置上用劳动或奴隶生产。</li>
<li>从附近的市场进口。</li>
</ol>

<p>第一种方式，玩家拥有对应原产地，然后在地皮上增加人口。但新增人口是农民，还需要从农民升级成劳工。国家 buf 中，默认只有原住民满意度对产量有轻微的增益。</p>

<p>第二种方式，玩家有更大的自主性。以铁为例，只要是湿地地形或者地皮邻接湖泊，就可以主动产铁。这种生产除同样需要劳工外，还有原料开销：把炭转换为铁。这种生产方式直接被市场接入率打折，即离市场越远的地方单位人口的生产效率越低，但同时有更多增加生产率的增益途径：最基本的就有当地劳工识字率和市民满意度。和虽然和第一种方式一样需要劳工，但游戏似乎会先满足原产需求的劳工，多出部分才进行建筑生产。所以在劳工不足时，若需进行建筑生产，需要主动减少原产等级。因为生产建筑可以由玩家主动关闭，但原产似乎不行。</p>

<p>第三种方式，通常需要在本地市场拥有一定的市场容量。在不考虑成本时，甚至可以亏本进货。对开荒来说，进口原料比进口成品的优势就在于占用更少的贸易容量。</p>

<p>为什么上面以铁举例，因为铁是开荒时最重要的资源。虽然木头和石头也很重要，但游戏把木材、粘土、沙、石头设定为一般物资，所有地块都有一个很低的默认产能，从市场角度看，根据市场规模，每个市场总有一定量的供给。但铁不属于这种物资。</p>

<p>建造建筑需要的基本材料是砖头，砖头可以通过基础建筑，从粘土或石头转换。</p>

<p>开发原产需要的基本材料是木头或工具。大多数基础建筑的生产配方里都需要工具。而工具在非城市生产建筑中，只有乡村市场可以把铁转换为工具。所以、如果开荒时的市场中缺铁，就只能通过进口。进口制造工具的铁比进口工具更能利用上贸易容量（铁和工具的单位贸易容量相同，但铁到工具以 4:5 转换）。</p>

<p>铁矿在版图上相对其它资源更少，所以一般开荒需更关注市场覆盖下有无湿地地形或有无湖泊，同时需要用充足的木材供应，可以把木材转换为炭再转换为铁。</p>

<p>一旦单一地块上的人口超过 5000 ，就可以升级为城镇，这种生产就有更多选择。以工具制造来说，城镇里就多出了用石头或铜转换为工具的配方。尤其是石制工具的途径，虽然效率很低，通常利润也很低，但贵在石头有保底产出。城镇的升级需要砖头和玻璃，玻璃可通过沙子转换，而沙子有保底产出或通过工具加木材转换。</p>

<p>开荒期间，解决了木头、砖头、玻璃、工具这四种基本货物（前三种是各种基础建筑建设需求，最后是大部分生产转换配方的必须）后，就要考虑提高产能的问题，这里的核心之一是纸。因为劳工识字率影响着生产率。纸是印书的原料、书是图书馆的维持品，而图书馆以及更多提高识字率相关的建筑都需要书。</p>

<p>造纸术需要纤维作物或皮革或布匹。纤维作物的基本生产方法是在对应农场通过牲畜木材工具制造；而牲畜则在耕种村落通过工具加粘土转换；皮革则可以在森林村落通过沙加焦油和野味转换，其中焦油在一般木材产区都可以通过木材转换得到。</p>

<p>另一个重要的资源是人口。它在游戏中和钱一样重要、甚至更重要。因为一切的生产行为都需要人。对开荒而言，升级到城市对效率影响最大，这里的硬性要求就是 5000 基础人口。除了主动殖民，就是本地土著转换、周边迁移（集中）以及自然生长率。这些都可以通过内阁行为略微加速，同样关键是修定居点（同时加移民吸引度和自然生长率）。定居点除了 250 农民外的维持成本是石头、木头、羊毛、野味。前两个一定有保底产出，后两个不是必须，缺少只会让效率打折，但供应充足可以发挥全部性能。定居点和乡村市场都占用农民，在最初阶段，我感觉乡村市场更重要一些，毕竟可以制造工具，还能提供宝贵的贸易容量。</p>

<p>不同阶层人口除了产生固定需求（吃掉本地市场的部分产出）外，更基本的需求是食物。EU5 中的食物系统设计，我觉得也是很巧妙的。</p>

<p>食物并不是货物的一种，而是和钱一样，表示为一个单一值。最主要的食物来源是生产带食物属性的货物（被称为食物原料）的副产品。属于食物原料的货物，被设定了不同的食物倍率，这就让有些食物原料产生食物的效率更高。不工作的劳工默认会以一个较低的产能生产食物，所以不必担心多出来的劳动力被浪费。另外，农民在森林村落里，虽然产品皮革并非食物原料，但生产行为本身被设定了食物产能。另外，农村相对城市有额外的食物产能的乘数增益。</p>

<p>食物的仓储按省份为单位计算，省份归属的若干地块共享一个食物仓库。在每个省份会优先填满仓亏，多出的部分卖给了所属市场，这里是不计市场接入度的。而一旦仓库有空间，就会从所属市场购买。战争是影响它的一个变数。因为军队也会从这个仓库中获取食物，围攻会阻止市场上的食物交易。</p>

<p>食物在本地市场上的交易行为会影响到本地食物价格，购买食物的开销和销售食物的收入是分开计算的，全部通过国库完成。市场间并不能单独交易食物，但通过对有食物原料属性的商品的交易，会产生附带的食物流通（但并不会产生额外的货币流动）。我觉得理论上会出现市场仓库中的食物储量为 0 ，但依然出口食物原料的情况，但实际玩的时候并没有发现，所以不清楚游戏怎样处理。但我猜测，食物流通是在单独层面计算的。既然超出市场食物容量的食物似乎就消失了，那么也可以接受万一食物储量为 0 却继续出口的情况，把储量设为 0 即可。</p>

<hr />

<p>最后，写写我对税收的看法。</p>

<p>简单说，游戏里的经济活动产生了税基。税基中按王室影响力直接把钱进入国库，另外的钱按阶层影响力分到了各阶层。但玩家可以对阶层分得的钱征税，让这些钱进入国库。</p>

<p>看起来，在不造成阶层不满的前提下，税率越高，国库收入就越高。但实际我玩的感觉是，其实税基才是整个国家的收入，国库仅仅是玩家可以主动调配的部分。阶层保留更多的收入，也会投入到国家发展中去，只不过有时不是玩家想要的方向，甚至是负方向。例如当玩家想削弱某个阶层的影响力时，阶层把钱投入都修建扩大本阶层影响力的建筑上。但总的来说，如果国库钱够用，更低的税收更好。因为税基相同时，税收影响的是分配。低税收必定增加阶层满意度，带来的正面增益是额外的。正所谓藏富于民。</p>

<p>而影响税基最重要的是地区控制度。当然地区控制度不仅仅影响税基，还影响了更多建筑的效率。从这个意义上来说，地方分权比中央集权更有利于经济发展。分封属国，尤其是朝贡国，比大一统国家会获得更好的经济局面。</p>

<p>但权力分配在游戏中也相当重要，因为它直接影响调配价值观的能力。价值观在一盘游戏进程中必须配合时代发展而演变才能更好的发展经济。而集权以及王室影响力是权利分配能力的来源。</p>

<p>所以说，最终玩整个游戏的体验还是在和面，只是多出了一份历史感。有了真实历史这种后验知识，才更为有趣。</p>
]]>
    </content>
</entry>
<entry>
    <title>嵌入主线程消息循环的任务调度器</title>
    <link rel="alternate" type="text/html" href="https://blog.codingnow.com/2025/11/task_schedule_in_eventloop.html" />
    <id>tag:blog.codingnow.com,2025://1.1318</id>
    
    <published>2025-11-22T05:52:56Z</published>
    <updated>2025-11-22T05:54:16Z</updated>
    
    <summary>最近在网友协助下把 soluna port 到包括 wasm 在内的非 windows 平台。其间遇到很多难题，大多是多线程环境的问题。因为 soluna 的根基就是基于 ltask 的多线程调度器，如果用单线程实现它，整个项目的意义就几乎不存在，所以它是把项目维护下去必须解决的问题。 好在 lua 有优秀的 coroutine 支持，它可以把运行流程抽象成数据，而 Lua 本身并未限制数据的具体储存方式，所以完全可以存在于内存堆中，脱离于 C 栈存在，这为各种在 C 环境下的多线程难题开了后门。C 语言依赖栈运行代码逻辑，而栈绑定于线程，线程调度通常由操作系统完成，所以用常规方式无法让代码跨线程运行：即，无法通过常规手法让一段代码的流程前半段在一个线程运行，而用另一个线程运行后半段；但是，在 C 上建立一个 Lua 层，则很容易绕开这个限制，只用标准方法就可以自由控制程序运行流程。 上一次发现利用一些技巧就可以完成一些看似不可能却的确可行的调度方式是 多线程串行运行 Lua 虚拟机 。 简单复述一下当时的需求：...</summary>
    <author>
        <name>云风</name>
        <uri>http://www.codingnow.com</uri>
    </author>
            <category term="lua与虚拟机" />
            <category term="游戏开发" />
    
    <content type="html" xml:lang="en" xml:base="https://blog.codingnow.com/">
        <![CDATA[<p>最近在网友协助下把 <a href="https://github.com/cloudwu/soluna">soluna</a> port 到包括 wasm 在内的非 windows 平台。其间遇到很多难题，大多是多线程环境的问题。因为 soluna 的根基就是基于 <a href="https://github.com/cloudwu/ltask">ltask</a> 的多线程调度器，如果用单线程实现它，整个项目的意义就几乎不存在，所以它是把项目维护下去必须解决的问题。</p>

<p>好在 lua 有优秀的 coroutine 支持，它可以把运行流程抽象成数据，而 Lua 本身并未限制数据的具体储存方式，所以完全可以存在于内存堆中，脱离于 C 栈存在，这为各种在 C 环境下的多线程难题开了后门。C 语言依赖栈运行代码逻辑，而栈绑定于线程，线程调度通常由操作系统完成，所以用常规方式无法让代码跨线程运行：即，无法通过常规手法让一段代码的流程前半段在一个线程运行，而用另一个线程运行后半段；但是，在 C 上建立一个 Lua 层，则很容易绕开这个限制，只用标准方法就可以自由控制程序运行流程。</p>

<p>上一次发现利用一些技巧就可以完成一些看似不可能却的确可行的调度方式是 <a href="https://blog.codingnow.com/2022/09/multithread_lua_vm.html">多线程串行运行 Lua 虚拟机</a> 。</p>

<p>简单复述一下当时的需求：</p>
]]>
        <![CDATA[<p>希望可以在单个 Lua 虚拟机内模拟多线程并发。当一个 Lua 的 coroutine 运行到 C 函数中时，若此刻 C 函数希望阻塞等待一个 IO 请求，常规的方法是 yield 回 Lua 虚拟机，让调度器持有一个 Lua coroutine 的状态，待完成 IO 请求后，再由调度器 resume 这个 coroutine 。这样做的难题是，运行到一半的 C 函数，上下文状态还在 C 所属线程的栈中，一旦 yield 回 Lua 虚拟机，必须放弃 C 栈上的状态，并在下次 resume 时可以重建。这通常难以实现，这也是为何 Lua 的 coroutine C api 难以理解又很难使用的原因。尤其使用第三方 C 库，几乎没可能适配。</p>

<p>另一个折中的方法是让 Lua 虚拟机在 C 函数中阻塞，硬等到 IO 操作完成。但在阻塞过程中，无法使用这个 Lua 虚拟机。若使用者期待 Lua 虚拟机中多个 coroutine 以多线程方式并行工作，恐怕会失望。即使其它 coroutine 的业务和 IO 完全无关，一个 IO 阻塞操作会让它完全无法并行工作。</p>

<p>变通的方式是（在编译时）打开 Lua 的线程锁。在调用 IO 阻塞前解开线程锁，只要 IO 操作本身不涉及对 Lua State 的操作，那么 Lua  解释器在调用 C 函数前的那一刻会解开线程锁，这样就可以允许阻塞操作过程中，Lua 虚拟机可以执行其它操作。</p>

<p>线程锁本身依赖系统线程库的调度器。不适合像 ltask 这样自己实现任务调度（即在有限个系统线程下调度远超系统线程数的任务）。但是，我们可以配合 ltask 实现类似的锁机制。这就是之前这个 patch 实现的东西：Lua 层调用可能阻塞的 C 函数前加锁通知 ltask 调度器，在 C 函数中，用户主动在阻塞操作前解锁。ltask 的调度器在 C 函数返回前就将虚拟机提前放回调度表。当阻塞操作完成后，重新加锁会等待调度器完成（如果有）正在运行的在同一个 Lua 虚拟机上的任务完成。这样，整个 Lua 虚拟机实质上还在串行运行其中的任务。而使用者看起来在一个 coroutine 尚未 yield 之前就开始运行另一个 coroutine ，直到其它 coroutine yield 后再继续未完的工作。同一个 Lua 虚拟机的多个 coroutine 是在多个操作系统线程上完成的，但却保持串行。</p>

<p>这个 patch 最终并未合并进 ltask ，因为我觉得它对使用者有更高的要求。但经此，我开了不少脑洞，明白在必要时牺牲一些复杂度就可以完成一些超乎寻常的任务。</p>

<hr />

<p>这次我面临的是新的问题：sokol 并未设计成线程安全。api 不能并发。一开始我并不想使用复杂的解决方案，以为只要保证 sokol 不并发就够了。期间遇到的问题是 <a href="https://blog.codingnow.com/2025/08/setwindowtext_deadlock.html">Windows API 死锁</a> ，也很容易绕过。</p>

<p>对于图形 API ，我只是简单的将图形 API 调用都塞在同一个 render 服务中。并在主线程的 sokol 回调函数中利用一个信号量和渲染过程同步。虽然 Direct3D ，Matal ，Vulkan 这些为多线程设计的底层图形 API 这么用都没有问题，但 OpenGL （在 Linux 上开启）却将状态放在当前线程上。一开始，我们通过额外调用 MakeCurrent 绕开限制，但在我们向 wasm 移植时却遇到障碍。</p>

<p>最终，我还是希望找到一个方法让所有图形 API 的调用都真正从主线程，也就是 sokol 提供的 callback 函数中发起。而不是用信号量同步，让它们在其它工作线程运行。</p>

<p>难题在于，主线程是通过事件消息循环驱动的，没有全部的控制权。不适合在其上实现任务调度器。一个任务调度器最好有所有时间片的控制权，它才好简单有效的分配时间片，没有任务时可以休眠而不是在事件循环没有新事件时强制休眠。我不想为这种特别的工作方式改造 ltask 的任务调度器，让主线程的事件回调函数伪装成一个功能不完整的特殊工作线程。我实际需要的是：把一个 Lua 虚拟机内的特定任务分配给主线程回调函数运行，在没有这种特定任务时，其它任务还是交给 ltask 做常规调度。</p>

<p>细想之下，解决方法和上一个需求有异曲同工之处：Lua 在启动这种特殊任务（必须在主线程回调函数内运行）前通知调度器。这时把虚拟机暂时移出调度表，而在主线程的回调函数中（通过信号量）发现有新任务到来，就接手处理特殊片段。处理完毕后，再把它归还给调度器。</p>

<p>通过这个方案，我们顺利把 soluna port 到 wasm 环境，同时简化了 Linux/OpenGL 实现。当我了解到 wasm 上有 pthread api 和原生 web worker api 两套多线程 api 后，我又信心满满的想用 worker api 来实现。但最终未能如愿。<a href="https://github.com/cloudwu/soluna/pull/54">具体讨论在这个 issue 中</a> ，倒不是完全做不到，而是我觉得不应该牺牲太多复杂度。比如把 soluna 中所有的 IO 操作都转发到主线程中运行（这是 web worker 的限制所在，也是 wasm pthread 原本要解决的问题）。</p>

<hr />

<p>昨天发现了上面解决方案实施中的一点纰漏：虽然给 ltask 打了个洞，可以在系统主线程夺过指定任务运行，但在交换控制权回调度器时，忽略了 ltask 的所有工作线程可能因为没有任务而全部休眠的可能性。仅仅把任务推回（线程安全的）任务队列是不够的。还需要重启调度器（如果处于休眠状态）。具体讨论见这个 <a href="https://github.com/cloudwu/soluna/issues/58">issue</a> 。</p>

<p>ps. 自从搬家后，我的 Linux 机器一直没有开机。昨天为了在 Linux 环境下测试，才重新装起来。bug 虽然重现，但视乎在我的机器上更为严重：一旦程序失去响应，整个系统都卡住了，甚至冷启动都没用。直接把机器弄死，而且五分钟内都开不了机（BIOS 进不去，屏幕无信号）。我怀疑是显卡驱动的 bug ，因为太久没升级系统，头一次升级还失败了，pacman 报告出现依赖问题拒绝更新。强删了几个 Electron （这个毒瘤）的几个历史版本后，系统升级才得以继续。最后更新了最新版的 Nvidia 包似乎就一切正常了。</p>
]]>
    </content>
</entry>
<entry>
    <title>欧陆风云 5 的经济系统</title>
    <link rel="alternate" type="text/html" href="https://blog.codingnow.com/2025/11/eu5.html" />
    <id>tag:blog.codingnow.com,2025://1.1317</id>
    
    <published>2025-11-04T22:07:40Z</published>
    <updated>2025-11-09T06:16:51Z</updated>
    
    <summary>很早从“舅舅”那里拿到了《欧陆风云 5》的试玩版。因为开发期的缘故，更新版本后需要重玩，所以一开始只是陆陆续续玩了十几个小时。前段时间从阳朔攀岩回来，据说已经是发售前最后一版了，便投入精力好好玩了 50 小时，感觉非常好。 我没有玩过这个系列的前作，但有 800 小时《群星》的经验，还有维多利亚 2/3 以及十字军之王 2/3 的近百小时游戏时间，对 P 社的大战略游戏的套路还是比较了解的。这一作中有很多似曾相识的机制，但玩进去又颇为新鲜，未曾在其它游戏中体验过。 我特别喜欢 P 社这种在微观上使用简洁公式，宏观展现出深度的游戏设计。我试着对游戏的一小部分设计作一些分析，记录一下它的经济系统是如何构建的。...</summary>
    <author>
        <name>云风</name>
        <uri>http://www.codingnow.com</uri>
    </author>
            <category term="游戏" />
    
    <content type="html" xml:lang="en" xml:base="https://blog.codingnow.com/">
        <![CDATA[<p>很早从“舅舅”那里拿到了《欧陆风云 5》的试玩版。因为开发期的缘故，更新版本后需要重玩，所以一开始只是陆陆续续玩了十几个小时。前段时间从阳朔攀岩回来，据说已经是发售前最后一版了，便投入精力好好玩了 50 小时，感觉非常好。</p>

<p>我没有玩过这个系列的前作，但有 800 小时《群星》的经验，还有维多利亚 2/3 以及十字军之王 2/3 的近百小时游戏时间，对 P 社的大战略游戏的套路还是比较了解的。这一作中有很多似曾相识的机制，但玩进去又颇为新鲜，未曾在其它游戏中体验过。</p>

<p>我特别喜欢 P 社这种在微观上使用简洁公式，宏观展现出深度的游戏设计。我试着对游戏的一小部分设计作一些分析，记录一下它的经济系统是如何构建的。</p>
]]>
        <![CDATA[<p>这里有一篇官方的开发日志：<a href="https://store.steampowered.com/news/app/3450310/view/518598560814465362">贸易与经济</a> 其实说得很清楚。但没自己玩恐怕无法理解。</p>

<p>我在玩了几十小时后，也只模糊勾勒出经济系统的大轮廓。下面是我自己的理解，可能还存在不少错误。</p>

<p>EU5 的经济系统由人口/货币/商品构成，市场为其中介。</p>

<p>游戏世界由无数地区构成。地区在一起可以构成国家，也能构成市场。一个国家可以对应一个市场，也可以由多个市场构成，也可以和其它国家共享市场。</p>

<p>每个市场都会以一个地区为市场中心，这反应了这个地区的经济影响力，它不同于国家以首都为中心的政治版图。市场自身会产生影响力，而市场中心地区的所属国家则因其政治影响力而产生市场保护力，两相作用决定了市场向外辐射的范围。每个地区在每个时刻都会根据受周围不同市场的影响强弱，最终归属到一个唯一市场。</p>

<p>每个地区有单一的原产物资（商品）。原产在版图上不会改变，可以被人口开发，计入所属市场供给。</p>

<p>地区上可以修建生产建筑，生产建筑通过人口把若干种商品转换为一种商品。转换效率受地区的市场接入率影响。市场中心地区的接入率为 100% ，远离市场的地区接入率下降，在边远地区甚至为 0 （这降低了同样人口的工作效率）。注：原产不受市场接入率的影响。</p>

<p>市场每种商品有供给和需求。每种商品有一个额定价格。需求和供给的多寡决定了目标价格和额定价格的差距，目标价格在 10% 到 500% 间变化。实际价格每个月会向目标价格变动，变动速度受物价波动率影响。</p>

<p>注：商品在每个市场有库存。库存和需求是独立的，库存多少不影响价格（供需状态影响它）。当需求超过供给时会消耗库存，反之则增加库存。库存有上限，一旦达到上限就无法进口。当贸易的交易对手需求大于供给时可以对其出口而无法进口，供给大于需求时可以从其进口，而无法出口；而自己只要有库存就可以出口（即使需求大于供给）。</p>

<p>商品的价格减去原料成本（原产物资没有原料成本）为其利润，利润以货币形式归属生产人口，并产生税基。</p>

<p>负利润的生产建筑会逐渐减员，削减产量，除非政府提供补贴。缺少原料的生产建筑会减产。</p>

<p>人口会对商品产生需求。食物类型的商品是最基本的需求。 不能满足食物需求的人口会饿死，不能满足其它需求的人口会产生不满。</p>

<p>对于单一市场：</p>

<ol>
<li>人口在市场上产生商品需求。</li>
<li>生产建筑通过人口生产出商品供给市场。</li>
<li>市场上的供给和需求影响了商品价格。</li>
<li>人口通过生产获取货币形式的利润，并产生税基。</li>
</ol>

<p>税基中的一部分货币留给人口，一部分以税收形式收归国库。</p>

<p>货币用来投资新增生产建筑，或对其升级。建筑升级需要商品，这部分商品以需求形式出现在市场。人口会用自己的钱自动投资建筑，玩家可以动用国库升级建筑。</p>

<p>多个市场间以贸易形式交换商品：</p>

<p>每个市场有一个贸易容量，贸易容量由市场中地区中的建筑获得。贸易容量用来向其它市场进出口商品。</p>

<p>市场所属国家拥有贸易竞争力，贸易竞争力决定了向市场交易的优先级。高优先级贸易竞争力的市场先消耗贸易容量达成交易。</p>

<p>商品在不同市场中的价差构成了贸易利润，其中需要扣除贸易成本（通常由两个市场中心间的距离决定）。贸易利润的一部分（由王权力度决定）进入国库，其它部分变为税基。</p>

<p>在国家主动进行贸易外，人口也有单独的贸易容量，自动在市场间贸易平衡供需。</p>

<hr />

<p>我觉得颇为有趣的部分是这个经济系统中货币和商品的关系。</p>

<p>游戏中的生态其实是用商品构成的：人口提供了商品的基本需求，同时人口也用来生产它们。在生产过程中，转换关系又产生了对原料的需求。为了提高生产力，需要建造和升级建筑，这些建筑本身又是由商品转换而来。所以这么看来，是这些商品构成了这个世界，从这个角度完全不涉及货币。</p>

<p>但货币是什么呢？货币是商品扭转的中介。因为原产是固定在世界的各个角落的，必须通过市场和贸易通达各处。</p>

<p>建立一个超大的单一市场可以避免贸易，它们都直接计入市场中心。但远离市场中心生产出来的商品（非原产）受市场接入度的影响而削弱生产效率，所以这个世界只能本分割成若干市场。不同市场由于供需关系不同而造成了物价波动。价差形成贸易的利润，让商品流动。这很好的体现了货币的本质：商品流动的中介。</p>

<p>政府通过税收和其主导的国家贸易行为获得货币，同时也可以通过铸币获取额外收益（并制造通货膨胀）。再用这些货币去投资引导世界的发展：建造和升级生产建筑光有钱是不行的，必须市场上有足够的商品；没有钱也是不行的，得负担得起市场上对应商品的价格。</p>

<p>注：铸币可以看作是用黄金或白银直接变成货币的生产行为。它的基础产能似乎和人口无关，也不需要分配人口去工作，也没有特定的生产地点 。只需要在国家结余菜单中勾选即可。选择更大的产能会导致货币贬值，本质上是单位黄金/白银兑换的价值变少，但游戏中是以通胀变现的。即，生产出来的货币并没有变少，但国家的通胀增加了。铸币行为表现为在市场中自动消耗一定量的贵金属。如果整个市场中都没有贵金属，也就无法铸币。</p>

<hr />

<p>11 月 7 日补充：</p>

<p>玩游戏的时候，一直没弄懂游戏中市场间的交易是怎么撮合的。官方 wiki 现在没有详细解释，游戏内的说明也不够完整。昨天和玩友讨论后，又仔细在游戏中研究了一下，发现其实游戏中说明还是很丰富的，只是细节散布在不同界面中。我是这样理解的：</p>

<p>由于同一市场中可能有不同国家的贸易建筑，所以导致了在一个市场中，不同国家分别拥有一定的贸易影响力和贸易容量。注：在友好的外国，可以修建贸易站，这种建筑占用当地的人口，为当地产生税基，但可以为本国带来贸易影响力和贸易容量。这些数值可以在市场界面上看到。</p>

<p>贸易影响力在出口紧俏商品时起作用，即商品的当月节余不能满足当月出口需求时，高影响力的贸易订单先被满足。在订单详情界面中可以看到相关商品的供给和需求细节。我不确定进口商品过多时是否也按影响力排序，游戏内的说明中说贸易影响力不影响进口，但我认为受商品仓库上限的影响，如果当月进口数量太多会超过库存上限，同样需要对进口订单排序。只不过在库存过高时，通常交易是负利润，很难出现这种情况罢了。</p>

<p>即使在一个外国市场内没有贸易容量，也可以发起贸易，只要该市场在你拥有贸易容量市场的贸易范围内。计算贸易距离似乎看的是市场边界的最短距离（而不是市场中心的距离），在贸易订单界面可以看到商品的出口地点和进口地点，很多时候并不是贸易中心地。贸易范围看起来是一个国家相关值。所以，在周边国家建贸易站可以扩展可以交易的市场。但如果在交易对手的市场内没有贸易容量，那么贸易影响力一定为零，对紧俏商品的采购很可能失败。</p>

<p>在两个市场间对某种商品进行贸易，会产生订单，同一商品只会有一张。订单上会指定商品数量，数量越多，消耗的贸易容量越大。每种商品有一个基础消耗比例，根据贸易距离乘一个系数。所以距离越远的贸易，消耗的贸易容量越大。在下订单时，并不能立刻确定是否能成交。如果商品库存不够，需要根据贸易影响力排序。低影响力国家发起的订单可能不能完全满足，甚至为 0 。这种情况下，订单所属的贸易容量就被浪费掉了。</p>

<p>每个订单可以看作是一支商队，贸易容量就是商队的规模。长途贸易需要支付额外的费用，可以理解为商队的工资以及海峡过路费等。这个费用以贸易容量为比例支付，而不是实际成就额。所以，即使订单数量为 0 ，这些额外费用也是要支付的。所以订单有亏本的风险。所以大容量订单（未能成交的）风险更大。如果是采购战略物资，采用多个小订单分散去不同市场采购获得足够成交数量更安全。</p>

<p>订单可以被人工固定，每月固定执行，但有更大的可能无法成交。大部分情况下，采用系统自动生成的订单。系统看起来会按利润多寡分配贸易容量。但似乎也不会产生过大的订单，具体规则没有写。总之，系统自动生成的订单浪费贸易容量的机率更小。</p>

<p>人口自身也有一定的贸易容量（独立于国家可以控制的贸易容量）自发进行贸易。对应的订单在游戏界面中无法查到。但在商品界面详情中可以看到一个合计数值，显示该商品由人口自发贸易行为产生的输入或输出总量。人口如何产生这些贸易的规则不清楚，从文字说明看，和人口自身的需求相关。我怀疑也和贸易利润相关。</p>
]]>
    </content>
</entry>

</feed> 

